(function(window){"use strict";var performance=window.performance||window.webkitPerformance||window.msPerformance||window.mozPerformance||{};performance.now=function(){return performance.now||performance.webkitNow||performance.msNow||performance.oNow||performance.mozNow||function(){return(new Date).getTime()}}();var defaults={performance:performance,ajaxs:[],param:{rate:.5,src:"http://localhost/tap/ajax/operate.php",download:{img:"http://h5dev.eclicks.cn/libs/common/img/bandwidth-5.png",size:4511798}}};if(window.primus.param){for(var key in window.primus.param){defaults.param[key]=window.primus.param[key]}}var primus=defaults;var firstScreenHeight=window.innerHeight;var doc=window.document;window.onerror=function(msg,url,line,col,error){var newMsg=msg;if(error&&error.stack){var stack=error.stack.replace(/\n/gi,"").split(/\bat\b/).slice(0,9).join("@").replace(/\?[^:]+/gi,"");var msg=error.toString();if(stack.indexOf(msg)<0){stack=msg+"@"+stack}newMsg=stack}var obj={msg:newMsg,target:url,rowNum:line,colNum:col};alert(obj.msg)};var _XMLHttpRequest=window.XMLHttpRequest;window.XMLHttpRequest=function(flags){var req;req=new _XMLHttpRequest(flags);monitorXHR(req);return req};var monitorXHR=function(req){req.ajax={};req.addEventListener("readystatechange",function(){if(this.readyState==4){req.ajax.end=primus.now();if(req.status>=200&&req.status<300||req.status==304){req.ajax.endBytes=_kb(req.responseText.length*2)}else{req.ajax.endBytes=0}req.ajax.interval=req.ajax.end-req.ajax.start;primus.ajaxs.push(req.ajax)}},false);var _open=req.open;req.open=function(type,url,async){req.ajax.type=type;req.ajax.url=url;return _open.apply(req,arguments)};var _send=req.send;req.send=function(data){req.ajax.start=primus.now();var bytes=0;if(data){req.ajax.startBytes=_kb(JSON.stringify(data).length*2)}return _send.apply(req,arguments)}};function _kb(bytes){return(bytes/1024).toFixed(2)}var imgLoadTime=0;function _setCurrent(){var current=Date.now();current>imgLoadTime&&(imgLoadTime=current)}doc.addEventListener("DOMContentLoaded",function(){var imgs=doc.querySelectorAll("img");imgs=[].slice.call(doc.querySelectorAll("img"));if(imgs){imgs.forEach(function(img){if(img.getBoundingClientRect().top>firstScreenHeight){return}if(img.complete){_setCurrent()}img.addEventListener("load",function(){_setCurrent()},false)})}if(primus.param.backgroundImages){primus.param.backgroundImages.forEach(function(url){var image=new Image;image.src=url;if(image.complete){_setCurrent()}image.onload=function(){_setCurrent()}})}},false);window.addEventListener("load",function(){setTimeout(function(){var time=primus.getTimes();var data={ajaxs:primus.ajaxs,dpi:primus.dpi(),time:time};primus.send(data)},500)});primus.print=function(obj,left,right,filter){var list=[],left=left||"",right=right||"";for(var key in obj){if(filter){if(filter(obj[key]))list.push(left+key+":"+obj[key]+right)}else{list.push(left+key+":"+obj[key]+right)}}return list};primus.getTimes=function(){var timing=performance.timing;if(timing===undefined){return false}var api={};if(timing){var firstPaint=0;if(window.chrome&&window.chrome.loadTimes){firstPaint=window.chrome.loadTimes().firstPaintTime*1e3;api.firstPaintTime=firstPaint-window.chrome.loadTimes().startLoadTime*1e3}else if(typeof timing.msFirstPaint==="number"){firstPaint=timing.msFirstPaint;api.firstPaintTime=firstPaint-timing.navigationStart}else{api.firstPaintTime=currentTime-timing.navigationStart}api.loadTime=timing.loadEventEnd-timing.navigationStart;api.unloadEventTime=timing.unloadEventEnd-timing.unloadEventStart;api.loadEventTime=timing.loadEventEnd-timing.loadEventStart;api.domReadyTime=timing.domContentLoadedEventEnd-timing.navigationStart;if(imgLoadTime==0){api.firstScreen=api.domReadyTime}else{api.firstScreen=imgLoadTime-timing.navigationStart}api.parseDomTime=timing.domComplete-timing.domInteractive;api.initDomTreeTime=timing.domInteractive-timing.responseEnd;api.readyStart=timing.fetchStart-timing.navigationStart;api.redirectTime=timing.redirectEnd-timing.redirectStart;api.appcacheTime=timing.domainLookupStart-timing.fetchStart;api.lookupDomainTime=timing.domainLookupEnd-timing.domainLookupStart;api.connectTime=timing.connectEnd-timing.connectStart;api.requestTime=timing.responseEnd-timing.requestStart;api.requestDocumentTime=timing.responseStart-timing.requestStart;api.responseDocumentTime=timing.responseEnd-timing.responseStart;api.TTFB=timing.responseStart-timing.navigationStart}return api};var marks={};primus.mark=function(markName){var now=performance.now();marks[markName]={startTime:Date.now(),start:now,duration:0}};primus.measure=function(startName,endName){var start=0,end=0;if(startName in marks){start=marks[startName].start}if(endName in marks){end=marks[endName].start}return{startTime:Date.now(),start:start,end:end,duration:end-start}};primus.getEntries=function(){if(performance.getEntries===undefined){return false}var entries=performance.getEntriesByType("resource");var statis=[];entries.forEach(function(t,index){var isRequest=t.name.indexOf("http")===0;console.log(t.name);var cur={name:t.name,fileName:t.name.split("/").pop(),duration:t.duration};if(t.requestStart){cur.requestStartDelay=t.requestStart-t.startTime;cur.lookupDomainTime=t.domainLookupEnd-t.domainLookupStart;cur.connectTime=t.connectEnd-t.connectStart;cur.TTFB=t.responseStart-t.startTime;cur.requestTime=t.responseEnd-t.requestStart;cur.requestDuration=t.responseStart-t.requestStart;cur.redirectTime=t.redirectEnd-t.redirectStart}if(t.secureConnectionStart){cur.ssl=t.connectEnd-t.secureConnectionStart}statis.push(cur)});return statis};primus.now=function(){return performance.now()};primus.network=function(){var connection=window.navigator.connection||window.navigator.mozConnection||window.navigator.webkitConnection;var types="Unknown Ethernet WIFI 2G 3G 4G".split(" ");var network={bandwidth:null,type:null};if(connection&&connection.type){network.type=types[connection.type]}return network};function _measureConnectionSpeed(){var startTime,endTime;var download=new Image;download.onload=function(){endTime=primus.now();var duration=(endTime-startTime)/1e3;var bitsLoaded=downloadSize*8;var speedBps=(bitsLoaded/duration).toFixed(2);var speedKbps=(speedBps/1024).toFixed(2);var speedMbps=(speedKbps/1024).toFixed(2);console.log(speedMbps)};startTime=primus.now();var cacheBuster="?rand="+startTime;download.src=imageAddr+cacheBuster}primus.ua=function(){return USERAGENT.analyze(navigator.userAgent)};primus.dpi=function(){return{width:window.screen.width,height:window.screen.height}};function _paramify(obj){return"data="+JSON.stringify(obj)}primus.send=function(data){var ts=(new Date).getTime().toString();if(primus.param.rate>Math.random(0,1)){var img=new Image(0,0);img.src=primus.param.src+"?"+_paramify(data)+"&ts="+ts}};var currentTime=Date.now();window.primus=primus})(this);